{% extends "base.html" %}
{% block title %}mysecond – Job {{ job.id[:8] }}{% endblock %}

{% block content %}
<div class="flex items-start justify-between mb-6">
  <div class="flex items-start gap-4">

    {# Determine the white player's username + platform for the avatar.
       Search jobs use player/opponent fields; all others use username. #}
    {% if job.command == 'search' %}
      {% if job.params.side == 'white' %}
        {% set _au = job.params.player | default('') %}
        {% set _ap = job.params.player_platform | default('lichess') %}
      {% else %}
        {% set _au = job.params.opponent | default('') %}
        {% set _ap = job.params.opponent_platform | default('lichess') %}
      {% endif %}
    {% else %}
      {% set _au = job.params.username | default('') %}
      {% set _ap = job.params.platform | default('lichess') %}
    {% endif %}

    {# Avatar circle #}
    {% if _au %}
    <div id="user-avatar"
         data-username="{{ _au }}" data-platform="{{ _ap }}"
         style="width:48px;height:48px;border-radius:50%;background:#1f2937;
                display:flex;align-items:center;justify-content:center;
                font-size:18px;font-weight:700;color:#9ca3af;
                overflow:hidden;flex-shrink:0;border:1px solid #374151;">
      {{ _au[0].upper() }}
    </div>
    {% endif %}

    <div>
      <div class="flex items-center gap-3 mb-1">
        <h1 class="text-2xl font-bold">
          {% if job.command == "fetch" %}Fetch Games
          {% elif job.command == "search" %}Search Novelties
          {% elif job.command == "habits" %}Analyse Habits
          {% elif job.command == "repertoire" %}Extract Repertoire
          {% elif job.command == "import" %}Import PGN
          {% else %}{{ job.command }}{% endif %}
        </h1>
        <span id="status-badge"
              class="status-{{ job.status }} text-xs font-mono uppercase border border-current px-2 py-0.5 rounded">
          {{ job.status }}
        </span>
      </div>
      <p class="text-gray-500 text-xs font-mono">{{ job.id }}</p>
      {% if _au %}
      <p class="text-gray-500 text-xs mt-0.5">
        {{ _au }}{% if _ap %} · {{ _ap }}{% endif %}
        {% if job.params.color %} · {{ job.params.color }}{% endif %}
      </p>
      {% endif %}
    </div>

  </div>

  <div class="flex gap-2 items-center">
    {% if job.command == 'search' %}
    <a href="/jobs/{{ job.id }}/novelties"
       class="btn-secondary {{ 'hidden' if job.status != 'done' or not job.out_path }}"
       id="browse-btn">
      Browse Novelties
    </a>
    {% endif %}
    {% if job.command == 'repertoire' %}
    <a href="/jobs/{{ job.id }}/repertoire-browser"
       class="btn-secondary {{ 'hidden' if job.status != 'done' or not job.out_path }}"
       id="browse-btn">
      Browse Repertoire
    </a>
    {% endif %}
    {% if job.command == 'habits' %}
    <a href="/jobs/{{ job.id }}/habits-browser"
       class="btn-secondary {{ 'hidden' if job.status != 'done' or not job.out_path }}"
       id="browse-btn">
      Browse Habits
    </a>
    <a href="/jobs/{{ job.id }}/habits-practice"
       class="btn-secondary {{ 'hidden' if job.status != 'done' or not job.out_path }}"
       id="practice-btn">
      Practice
    </a>
    {% endif %}
    {% if job.command in ('search', 'habits', 'repertoire') %}
    <a id="download-btn"
       href="/api/jobs/{{ job.id }}/download"
       class="btn-primary {{ 'hidden' if job.status != 'done' or not job.out_path }}"
       download>
      ↓ Download PGN
    </a>
    {% endif %}
    <a href="/jobs" class="btn-secondary text-sm">← History</a>
  </div>
</div>

<!-- Params summary -->
<details class="bg-gray-900 border border-gray-800 rounded-lg px-4 py-3 mb-4 text-sm">
  <summary class="text-gray-400 cursor-pointer">Job Parameters</summary>
  <pre class="mt-2 text-xs text-gray-300 whitespace-pre-wrap">{{ job.params | tojson(indent=2) }}</pre>
</details>

<!-- Novelty summary (search jobs only; populated by JS) -->
{% if job.command == 'search' %}
<div id="novelty-summary" style="display:none"
     class="bg-gray-900 border border-gray-800 rounded-lg p-4 mb-4">
  <p class="text-gray-400 text-xs uppercase tracking-wider font-semibold mb-3">Novelties Found</p>
  <div id="summary-body" class="text-sm text-gray-500">Loading…</div>
</div>
{% endif %}

<!-- Habits summary (habits jobs only; populated by JS) -->
{% if job.command == 'habits' %}
<div id="habits-summary" style="display:none"
     class="bg-gray-900 border border-gray-800 rounded-lg p-4 mb-4">
  <p class="text-gray-400 text-xs uppercase tracking-wider font-semibold mb-3">Habit Inaccuracies Found</p>
  <div id="habits-summary-body" class="text-sm text-gray-500">Loading…</div>
</div>
{% endif %}

<!-- Log output -->
<div class="relative">
  <pre id="log-output"
       class="bg-gray-900 border border-gray-800 rounded-lg p-4 h-[32rem] overflow-y-auto
              font-mono text-sm text-green-300 whitespace-pre-wrap leading-relaxed"></pre>
  <div class="absolute bottom-3 right-3">
    <label class="flex items-center gap-1.5 text-xs text-gray-500 cursor-pointer select-none">
      <input type="checkbox" id="autoscroll" checked class="accent-amber-400">
      Auto-scroll
    </label>
  </div>
</div>

<!-- Exit code -->
{% if job.exit_code is not none %}
<p class="mt-2 text-xs text-gray-600">Exit code: {{ job.exit_code }}</p>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
const JOB_ID     = {{ job.id | tojson }};
const JOB_STATUS = {{ job.status | tojson }};

// ── Avatar ──────────────────────────────────────────────────────────────────
(function () {
  const el = document.getElementById('user-avatar');
  if (!el) return;
  const username = el.dataset.username;
  const platform = el.dataset.platform;
  if (!username || platform !== 'chesscom') return;
  fetch(`https://api.chess.com/pub/player/${username}`)
    .then(r => r.ok ? r.json() : null)
    .then(data => {
      if (!data?.avatar) return;
      el.style.background = 'transparent';
      el.innerHTML = '';
      const img = document.createElement('img');
      img.src = data.avatar;
      img.alt = username;
      img.style.cssText = 'width:100%;height:100%;object-fit:cover;border-radius:50%;display:block;';
      el.appendChild(img);
    })
    .catch(() => {});
})();
// ────────────────────────────────────────────────────────────────────────────

const logEl    = document.getElementById('log-output');
const badge    = document.getElementById('status-badge');
const dlBtn    = document.getElementById('download-btn');
const autoChk  = document.getElementById('autoscroll');

function appendLine(line) {
  logEl.textContent += line + '\n';
  if (autoChk.checked) logEl.scrollTop = logEl.scrollHeight;
}

function markDone(status) {
  badge.textContent = status;
  badge.className = `status-${status} text-xs font-mono uppercase border border-current px-2 py-0.5 rounded`;
  if (status === 'done' && dlBtn) dlBtn.classList.remove('hidden');
  if (status === 'done') {
    ['browse-btn', 'practice-btn'].forEach(id => {
      const btn = document.getElementById(id);
      if (btn) btn.classList.remove('hidden');
    });
  }
  if (status === 'done') {
    loadNoveltySummary();
    loadHabitsSummary();
  }
}

function loadNoveltySummary() {
  const summaryDiv = document.getElementById('novelty-summary');
  if (!summaryDiv) return;
  summaryDiv.style.display = 'block';
  fetch(`/api/jobs/${JOB_ID}/novelties`)
    .then(r => r.json())
    .then(data => {
      const body = document.getElementById('summary-body');
      if (!data.length) {
        body.textContent = 'No novelties found.';
        return;
      }
      function evalColor(cp) {
        return cp >= 50 ? '#4ade80' : cp >= 10 ? '#fbbf24' : cp >= -10 ? '#f3f4f6' : '#f87171';
      }
      function moveLabel(n) {
        const ply = n.book_moves_san.length;
        const num = Math.floor(ply / 2) + 1;
        const dots = ply % 2 === 1 ? '\u2026' : '.';
        return `${num}${dots}${n.novelty_san}`;
      }
      body.innerHTML = `
        <table style="width:100%;border-collapse:collapse;font-size:12px;">
          <thead>
            <tr style="color:#6b7280;text-transform:uppercase;letter-spacing:.05em;font-size:10px;">
              <th style="padding:3px 8px;text-align:left;">#</th>
              <th style="padding:3px 8px;text-align:left;">Move</th>
              <th style="padding:3px 8px;text-align:right;">Ply</th>
              <th style="padding:3px 8px;text-align:right;">Eval</th>
              <th style="padding:3px 8px;text-align:right;">Pre</th>
              <th style="padding:3px 8px;text-align:right;">Post</th>
            </tr>
          </thead>
          <tbody>
            ${data.map(n => `
              <tr style="border-top:1px solid #1f2937;">
                <td style="padding:4px 8px;color:#6b7280;">${n.rank}</td>
                <td style="padding:4px 8px;font-family:monospace;font-weight:600;color:#f3f4f6;">
                  ${moveLabel(n)}
                </td>
                <td style="padding:4px 8px;text-align:right;color:#9ca3af;">${n.book_moves_san.length + 1}</td>
                <td style="padding:4px 8px;text-align:right;font-family:monospace;color:${evalColor(n.eval_cp)};">
                  ${n.eval_cp >= 0 ? '+' : ''}${n.eval_cp.toFixed(0)}
                </td>
                <td style="padding:4px 8px;text-align:right;color:#9ca3af;">${n.pre_novelty_games.toLocaleString()}</td>
                <td style="padding:4px 8px;text-align:right;color:${n.post_novelty_games === 0 ? '#60a5fa' : '#9ca3af'};">
                  ${n.post_novelty_games === 0 ? 'TN' : n.post_novelty_games}
                </td>
              </tr>`).join('')}
          </tbody>
        </table>`;
    })
    .catch(() => {
      const body = document.getElementById('summary-body');
      if (body) body.textContent = 'Could not load novelty data.';
    });
}

function loadHabitsSummary() {
  const summaryDiv = document.getElementById('habits-summary');
  if (!summaryDiv) return;
  summaryDiv.style.display = 'block';
  fetch(`/api/jobs/${JOB_ID}/habits`)
    .then(r => r.json())
    .then(data => {
      const body = document.getElementById('habits-summary-body');
      if (!data.length) {
        body.textContent = 'No habit inaccuracies found.';
        return;
      }
      function gapColor(gap) {
        return gap >= 75 ? '#f87171' : gap >= 25 ? '#fbbf24' : '#9ca3af';
      }
      body.innerHTML = `
        <table style="width:100%;border-collapse:collapse;font-size:12px;">
          <thead>
            <tr style="color:#6b7280;text-transform:uppercase;letter-spacing:.05em;font-size:10px;">
              <th style="padding:3px 8px;text-align:left;">#</th>
              <th style="padding:3px 8px;text-align:left;">Player's Move</th>
              <th style="padding:3px 8px;text-align:left;">Best Move</th>
              <th style="padding:3px 8px;text-align:right;">Gap</th>
              <th style="padding:3px 8px;text-align:right;">Freq</th>
              <th style="padding:3px 8px;text-align:right;">Score</th>
            </tr>
          </thead>
          <tbody>
            ${data.slice(0, 10).map(h => `
              <tr style="border-top:1px solid #1f2937;">
                <td style="padding:4px 8px;color:#6b7280;">${h.rank}</td>
                <td style="padding:4px 8px;font-family:monospace;font-weight:600;color:#f87171;">
                  ${h.player_move_san}${h.eval_gap_cp >= 75 ? '?' : '?!'}
                </td>
                <td style="padding:4px 8px;font-family:monospace;color:#4ade80;">${h.best_move_san}</td>
                <td style="padding:4px 8px;text-align:right;font-family:monospace;color:${gapColor(h.eval_gap_cp)};">
                  ${h.eval_gap_cp >= 0 ? '+' : ''}${h.eval_gap_cp.toFixed(0)}cp
                </td>
                <td style="padding:4px 8px;text-align:right;color:#9ca3af;">${h.total_games}×</td>
                <td style="padding:4px 8px;text-align:right;color:#fbbf24;">${h.score.toFixed(1)}</td>
              </tr>`).join('')}
          </tbody>
        </table>
        ${data.length > 10 ? `<p style="color:#6b7280;font-size:11px;margin-top:6px;padding:0 8px;">… and ${data.length - 10} more. <a href="/jobs/${JOB_ID}/habits-browser" style="color:#fbbf24;">Browse all →</a></p>` : ''}`;
    })
    .catch(() => {
      const body = document.getElementById('habits-summary-body');
      if (body) body.textContent = 'Could not load habits data.';
    });
}

// Load summary immediately if job is already done.
if (JOB_STATUS === 'done') {
  loadNoveltySummary();
  loadHabitsSummary();
}

// Connect SSE only if job is/was running.
if (JOB_STATUS === 'running') {
  const es = new EventSource(`/api/jobs/${JOB_ID}/stream`);

  es.onmessage = (e) => {
    const { line } = JSON.parse(e.data);
    appendLine(line);
  };

  es.addEventListener('done', () => {
    es.close();
    // Fetch final status to update badge + download button.
    fetch(`/api/jobs/${JOB_ID}`)
      .then(r => r.json())
      .then(j => markDone(j.status));
  });

  es.onerror = () => {
    appendLine('[connection lost – refresh to reconnect]');
    es.close();
  };
} else {
  // Job already finished: buffer all replayed lines, then set textContent once.
  // Doing textContent += per-line is O(n²) and forces a reflow each time —
  // with thousands of log lines this freezes the browser.
  const replayBuf = [];
  const es = new EventSource(`/api/jobs/${JOB_ID}/stream`);
  es.onmessage = (e) => {
    replayBuf.push(JSON.parse(e.data).line);
  };
  es.addEventListener('done', () => {
    es.close();
    logEl.textContent = replayBuf.join('\n');
    if (autoChk.checked) logEl.scrollTop = logEl.scrollHeight;
  });
}
</script>
{% endblock %}
