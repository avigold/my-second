{% extends "base.html" %}
{% block title %}mysecond – Strategise{% endblock %}

{% block content %}
<h1 class="text-2xl font-bold mb-2">Strategise</h1>
<p class="text-gray-400 text-sm mb-6">
  Analyse both players' repertoires, playing styles, strengths and weaknesses,
  then generate a strategic preparation brief.
  Games are fetched automatically if not already cached.
</p>

<form id="strategise-form" class="space-y-6 max-w-2xl">

  <!-- Two-column player / opponent -->
  <div class="grid grid-cols-2 gap-6">

    <!-- Player -->
    <div class="space-y-3">
      <h2 class="text-xs font-semibold text-amber-400 uppercase tracking-widest">Preparing Player</h2>
      <div>
        <label class="form-label">Username *</label>
        <input id="player" name="player" class="form-input" placeholder="e.g. Hikaru" required>
      </div>
      <div>
        <label class="form-label">Colour *</label>
        <select id="player_color" name="player_color" class="form-input" required>
          <option value="white">White</option>
          <option value="black">Black</option>
        </select>
      </div>
      <div>
        <label class="form-label">Platform</label>
        <select id="player_platform" name="player_platform" class="form-input">
          <option value="lichess">Lichess</option>
          <option value="chesscom">Chess.com</option>
        </select>
      </div>
      <div>
        <label class="form-label">Time Controls</label>
        <input id="player_speeds" name="player_speeds" class="form-input" value="blitz,rapid,classical">
      </div>
    </div>

    <!-- Opponent -->
    <div class="space-y-3">
      <h2 class="text-xs font-semibold text-red-400 uppercase tracking-widest">Opponent</h2>
      <div>
        <label class="form-label">Username *</label>
        <input id="opponent" name="opponent" class="form-input" placeholder="e.g. MagnusCarlsen" required>
      </div>
      <div class="h-[58px]"></div><!-- spacer matching colour row -->
      <div>
        <label class="form-label">Platform</label>
        <select id="opponent_platform" name="opponent_platform" class="form-input">
          <option value="lichess">Lichess</option>
          <option value="chesscom">Chess.com</option>
        </select>
      </div>
      <div>
        <label class="form-label">Time Controls</label>
        <input id="opponent_speeds" name="opponent_speeds" class="form-input" value="blitz,rapid,classical">
      </div>
    </div>
  </div>

  <!-- Advanced -->
  <details class="bg-gray-900 border border-gray-800 rounded-lg p-4">
    <summary class="text-sm font-medium text-gray-300">Advanced Parameters</summary>
    <div class="mt-3 grid grid-cols-2 gap-4">
      <div>
        <label class="form-label">Min Games at Position</label>
        <input id="min_games" name="min_games" type="number" class="form-input" value="5">
      </div>
      <div>
        <label class="form-label">Min Eval Gap (cp)</label>
        <input id="min_eval_gap" name="min_eval_gap" type="number" class="form-input" value="25">
      </div>
      <div>
        <label class="form-label">Max Positions to Report</label>
        <input id="max_positions" name="max_positions" type="number" class="form-input" value="30">
      </div>
      <div>
        <label class="form-label">Engine Depth</label>
        <input id="depth" name="depth" type="number" class="form-input" value="18">
      </div>
      <div class="col-span-2">
        <label class="form-label">Anthropic API Key (optional — for AI brief)</label>
        <input id="api_key" name="api_key" type="password" class="form-input"
               value="{{ anthropic_api_key }}"
               placeholder="sk-ant-… or set ANTHROPIC_API_KEY env var">
      </div>
    </div>
  </details>

  <p id="error-msg" class="text-red-400 text-sm hidden"></p>

  <button type="submit" id="submit-btn" class="btn-primary">Run Strategise</button>
</form>
{% endblock %}

{% block scripts %}
<script>
document.getElementById('strategise-form').addEventListener('submit', async (e) => {
  e.preventDefault();
  const btn = document.getElementById('submit-btn');
  const err = document.getElementById('error-msg');
  btn.disabled = true;
  btn.textContent = 'Starting…';
  err.classList.add('hidden');

  const params = {
    player:            document.getElementById('player').value.trim(),
    player_color:      document.getElementById('player_color').value,
    player_platform:   document.getElementById('player_platform').value,
    player_speeds:     document.getElementById('player_speeds').value.trim(),
    opponent:          document.getElementById('opponent').value.trim(),
    opponent_platform: document.getElementById('opponent_platform').value,
    opponent_speeds:   document.getElementById('opponent_speeds').value.trim(),
    min_games:         parseInt(document.getElementById('min_games').value) || 5,
    min_eval_gap:      parseInt(document.getElementById('min_eval_gap').value) || 25,
    max_positions:     parseInt(document.getElementById('max_positions').value) || 30,
    depth:             parseInt(document.getElementById('depth').value) || 18,
    api_key:           document.getElementById('api_key').value.trim() || null,
  };

  try {
    const res  = await fetch('/api/strategise', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(params),
    });
    const data = await res.json();
    if (!res.ok) throw new Error(data.error || 'Unknown error');
    window.location.href = `/jobs/${data.job_id}`;
  } catch (ex) {
    err.textContent = ex.message;
    err.classList.remove('hidden');
    btn.disabled = false;
    btn.textContent = 'Run Strategise';
  }
});
</script>
{% endblock %}
