{% extends "base.html" %}
{% block title %}Admin · mysecond{% endblock %}
{% block main_class %}max-w-7xl{% endblock %}
{% block main_padding %}py-6{% endblock %}

{% block content %}

<div class="flex items-center justify-between mb-6">
  <h1 class="text-xl font-bold text-purple-400">Admin Dashboard</h1>
  <span class="text-xs text-gray-600 font-mono">mysecond.app</span>
</div>

<!-- ─── Stats cards ────────────────────────────────────────────────── -->
<div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8" id="admin-stats">
  <div class="stat-card" id="stat-users">
    <div class="stat-value" id="sv-users">…</div>
    <div class="stat-label">Total Users</div>
  </div>
  <div class="stat-card" id="stat-pro">
    <div class="stat-value" style="color:#4ade80;" id="sv-pro">…</div>
    <div class="stat-label">Pro Subscribers</div>
  </div>
  <div class="stat-card" id="stat-today">
    <div class="stat-value" style="color:#60a5fa;" id="sv-today">…</div>
    <div class="stat-label">Jobs Today</div>
  </div>
  <div class="stat-card" id="stat-running">
    <div class="stat-value" style="color:#f59e0b;" id="sv-running">…</div>
    <div class="stat-label">Running / Queued</div>
  </div>
</div>

<!-- ─── Users table ────────────────────────────────────────────────── -->
<section class="mb-10">
  <div class="flex items-center justify-between mb-3">
    <h2 class="text-xs font-semibold text-gray-500 uppercase tracking-wider">Users</h2>
    <span class="text-xs text-gray-600" id="users-count"></span>
  </div>
  <div class="overflow-x-auto rounded-xl border border-gray-800" style="background:#0f172a;">
    <table class="w-full text-sm">
      <thead>
        <tr class="border-b border-gray-800 text-xs text-gray-500 uppercase tracking-wider">
          <th class="px-4 py-3 text-left">Username</th>
          <th class="px-4 py-3 text-left">Platform</th>
          <th class="px-4 py-3 text-left">Role</th>
          <th class="px-4 py-3 text-left">Plan</th>
          <th class="px-4 py-3 text-right">Jobs</th>
          <th class="px-4 py-3 text-left">Last Active</th>
          <th class="px-4 py-3 text-left">Joined</th>
        </tr>
      </thead>
      <tbody id="users-tbody">
        <tr><td colspan="7" class="px-4 py-6 text-center text-gray-600 text-xs">Loading…</td></tr>
      </tbody>
    </table>
  </div>
</section>

<!-- ─── Jobs table ─────────────────────────────────────────────────── -->
<section>
  <div class="flex items-center justify-between mb-3">
    <h2 class="text-xs font-semibold text-gray-500 uppercase tracking-wider">Recent Jobs</h2>
    <span class="text-xs text-gray-600" id="jobs-count"></span>
  </div>
  <div class="overflow-x-auto rounded-xl border border-gray-800" style="background:#0f172a;">
    <table class="w-full text-sm">
      <thead>
        <tr class="border-b border-gray-800 text-xs text-gray-500 uppercase tracking-wider">
          <th class="px-4 py-3 text-left">ID</th>
          <th class="px-4 py-3 text-left">Command</th>
          <th class="px-4 py-3 text-left">Status</th>
          <th class="px-4 py-3 text-left">User</th>
          <th class="px-4 py-3 text-left">Params</th>
          <th class="px-4 py-3 text-left">Started</th>
        </tr>
      </thead>
      <tbody id="jobs-tbody">
        <tr><td colspan="6" class="px-4 py-6 text-center text-gray-600 text-xs">Loading…</td></tr>
      </tbody>
    </table>
  </div>
</section>

{% endblock %}

{% block scripts %}
<style>
  .stat-card {
    background: #0f172a;
    border: 1px solid #1f2937;
    border-radius: 12px;
    padding: 20px 16px;
    text-align: center;
  }
  .stat-value {
    font-size: 2rem;
    font-weight: 700;
    color: #c084fc;
    font-family: monospace;
    line-height: 1.1;
    margin-bottom: 4px;
  }
  .stat-label {
    font-size: 0.65rem;
    color: #6b7280;
    text-transform: uppercase;
    letter-spacing: 0.07em;
  }
  .admin-table-row td { border-bottom: 1px solid #111827; }
  .admin-table-row:last-child td { border-bottom: none; }
  .admin-table-row:hover td { background: rgba(255,255,255,0.015); }

  .role-select {
    background: #1f2937;
    border: 1px solid #374151;
    border-radius: 4px;
    color: #d1d5db;
    font-size: 11px;
    padding: 2px 6px;
    cursor: pointer;
  }
  .role-select:focus { border-color: #c084fc; outline: none; }

  .badge {
    display: inline-block;
    font-size: 10px;
    padding: 1px 6px;
    border-radius: 4px;
    font-weight: 600;
  }
  .badge-pro      { background:#064e3b; color:#4ade80; }
  .badge-free     { background:#1f2937; color:#6b7280; }
  .badge-admin    { background:#3b0764; color:#c084fc; }
  .badge-titled   { background:#1c1917; color:#f59e0b; }
  .badge-running  { background:#1e3a5f; color:#60a5fa; }
  .badge-done     { background:#052e16; color:#4ade80; }
  .badge-failed   { background:#450a0a; color:#f87171; }
  .badge-queued   { background:#1c1917; color:#fbbf24; }
  .badge-other    { background:#1f2937; color:#6b7280; }
</style>

<script>
const TITLED_ROLES = new Set(['GM','WGM','IM','WIM','FM','WFM','CM','WCM','NM']);
const ALL_ROLES = ['user','GM','WGM','IM','WIM','FM','WFM','CM','WCM','NM','admin'];

// ─── User map (id → username) built after users load ─────────────────
let userMap = {};

// ─── Stats ────────────────────────────────────────────────────────────
async function loadStats() {
  try {
    const r = await fetch('/api/admin/stats');
    if (!r.ok) throw new Error(r.status);
    const s = await r.json();
    document.getElementById('sv-users').textContent   = s.total_users;
    document.getElementById('sv-pro').textContent     = s.pro_subscribers;
    document.getElementById('sv-today').textContent   = s.jobs_today;
    document.getElementById('sv-running').textContent = s.running_jobs;
  } catch(e) {
    console.error('stats', e);
  }
}

// ─── Helpers ──────────────────────────────────────────────────────────
function fmtDate(iso) {
  if (!iso) return '—';
  return new Date(iso).toLocaleString(undefined, {
    month:'short', day:'numeric', year:'numeric',
    hour:'2-digit', minute:'2-digit',
  });
}

function roleBadge(role) {
  if (role === 'admin')         return `<span class="badge badge-admin">${role}</span>`;
  if (TITLED_ROLES.has(role))   return `<span class="badge badge-titled">${role}</span>`;
  return `<span class="badge badge-free">${role}</span>`;
}

function planBadge(plan, sub_status) {
  if (plan === 'pro' && ['active','trialing'].includes(sub_status))
    return `<span class="badge badge-pro">pro</span>`;
  return `<span class="badge badge-free">free</span>`;
}

function statusBadge(status) {
  const cls = {running:'badge-running', done:'badge-done', failed:'badge-failed',
                queued:'badge-queued'}[status] || 'badge-other';
  return `<span class="badge ${cls}">${status}</span>`;
}

// ─── Users ────────────────────────────────────────────────────────────
async function loadUsers() {
  try {
    const r = await fetch('/api/admin/users');
    if (!r.ok) throw new Error(r.status);
    const users = await r.json();

    userMap = {};
    users.forEach(u => { userMap[u.id] = u.username; });

    document.getElementById('users-count').textContent = `${users.length} users`;
    const tbody = document.getElementById('users-tbody');
    if (!users.length) {
      tbody.innerHTML = '<tr><td colspan="7" class="px-4 py-6 text-center text-gray-600 text-xs">No users yet.</td></tr>';
      return;
    }
    tbody.innerHTML = users.map(u => `
      <tr class="admin-table-row" data-uid="${u.id}">
        <td class="px-4 py-3 font-mono text-sm text-gray-200">${escHtml(u.username)}</td>
        <td class="px-4 py-3 text-xs text-gray-500">${escHtml(u.platform)}</td>
        <td class="px-4 py-3">
          <select class="role-select" data-uid="${u.id}" onchange="setRole('${u.id}', this.value)">
            ${ALL_ROLES.map(r => `<option value="${r}" ${r === u.role ? 'selected' : ''}>${r}</option>`).join('')}
          </select>
        </td>
        <td class="px-4 py-3">${planBadge(u.plan, u.sub_status)}</td>
        <td class="px-4 py-3 text-right font-mono text-xs text-gray-400">${u.total_jobs}</td>
        <td class="px-4 py-3 text-xs text-gray-500">${fmtDate(u.last_active)}</td>
        <td class="px-4 py-3 text-xs text-gray-600">${fmtDate(u.created_at)}</td>
      </tr>
    `).join('');
  } catch(e) {
    document.getElementById('users-tbody').innerHTML =
      `<tr><td colspan="7" class="px-4 py-4 text-red-400 text-xs px-4">Error: ${e}</td></tr>`;
  }
}

async function setRole(userId, role) {
  try {
    const r = await fetch(`/api/admin/users/${userId}/role`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ role }),
    });
    if (!r.ok) {
      const d = await r.json();
      alert(`Error: ${d.error || r.status}`);
    }
  } catch(e) {
    alert(`Network error: ${e}`);
  }
}

// ─── Jobs ─────────────────────────────────────────────────────────────
async function loadJobs() {
  try {
    const r = await fetch('/api/admin/jobs');
    if (!r.ok) throw new Error(r.status);
    const jobs = await r.json();
    document.getElementById('jobs-count').textContent = `last ${jobs.length}`;
    const tbody = document.getElementById('jobs-tbody');
    if (!jobs.length) {
      tbody.innerHTML = '<tr><td colspan="6" class="px-4 py-6 text-center text-gray-600 text-xs">No jobs yet.</td></tr>';
      return;
    }
    tbody.innerHTML = jobs.map(j => {
      const p = j.params || {};
      const desc = j.command === 'fetch'      ? `${p.username||''} / ${p.color||''}`
                 : j.command === 'import'     ? `${p.username||''} / ${p.color||''} — ${p.filename||'PGN'}`
                 : j.command === 'habits'     ? `${p.username||''} / ${p.color||''}`
                 : j.command === 'repertoire' ? `${p.username||''} / ${p.color||''}`
                 : j.command === 'strategise' ? `${p.player||''} vs ${p.opponent||''}`
                 : j.command === 'search'     ? `${p.side||''} · ${p.player||p.username||''}`
                 : JSON.stringify(p).slice(0,40);
      const username = j.user_id ? (userMap[j.user_id] || j.user_id.slice(0,8)) : '—';
      return `
        <tr class="admin-table-row">
          <td class="px-4 py-3 font-mono text-xs text-gray-600">
            <a href="/jobs/${j.id}" class="hover:text-amber-400 transition-colors">${j.id.slice(0,8)}</a>
          </td>
          <td class="px-4 py-3">
            <span class="text-xs bg-gray-800 px-2 py-0.5 rounded text-gray-400">${escHtml(j.command)}</span>
          </td>
          <td class="px-4 py-3">${statusBadge(j.status)}</td>
          <td class="px-4 py-3 text-xs text-gray-400">${escHtml(username)}</td>
          <td class="px-4 py-3 text-xs text-gray-500 max-w-xs truncate">${escHtml(desc)}</td>
          <td class="px-4 py-3 text-xs text-gray-600">${fmtDate(j.started_at)}</td>
        </tr>
      `;
    }).join('');
  } catch(e) {
    document.getElementById('jobs-tbody').innerHTML =
      `<tr><td colspan="6" class="px-4 py-4 text-red-400 text-xs">Error: ${e}</td></tr>`;
  }
}

function escHtml(s) {
  return String(s || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

// ─── Init ─────────────────────────────────────────────────────────────
loadStats();
loadUsers().then(() => loadJobs());
</script>
{% endblock %}
